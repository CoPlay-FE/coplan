name: Deploy to EC2

on:
  pull_request:
    types: [closed]
    branches: [main, develop]

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: self-hosted
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v3

      - name: Deploy to EC2
        run: |
          set -e

          # ë°°í¬ ë¡œê¹…
          echo "ğŸš€ Starting deployment..."
          echo "ğŸ“ PR: #${{ github.event.pull_request.number }}"
          echo "ğŸ”„ Commit: ${{ github.sha }}"

          # ë©”ëª¨ë¦¬ ì •ë¦¬
          echo "ğŸ§¹ Cleaning up Docker resources..."
          docker system prune -f

          # ë¸Œëœì¹˜ë³„ í™˜ê²½ ì„¤ì •
          if [ "${{ github.event.pull_request.base.ref }}" = "main" ]; then
            CONTAINER_NAME="app-prod"
            ENV_FILE="app-prod.env"
            OTHER_CONTAINER="app-dev"
            echo "ğŸš€ Deploying to PRODUCTION"
          elif [ "${{ github.event.pull_request.base.ref }}" = "develop" ]; then
            CONTAINER_NAME="app-dev"
            ENV_FILE="app-dev.env"
            OTHER_CONTAINER="app-prod"
            echo "ğŸ§ª Deploying to DEVELOPMENT"
          fi

          # ë°°í¬ ë””ë ‰í† ë¦¬ ì„¤ì •
          DEPLOY_DIR="/home/ubuntu/coplan/app"

          # ë©”ëª¨ë¦¬ í™•ë³´ë¥¼ ìœ„í•´ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
          echo "â¸ï¸ Stopping other container to free memory..."
          docker compose stop ${OTHER_CONTAINER} || true

          # rsyncë¡œ íŒŒì¼ ë™ê¸°í™”
          echo "ğŸ“‚ Synchronizing files..."
          rsync -av \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.next' \
            --exclude='.env*' \
            --exclude='*.log' \
            --delete \
            ./ ${DEPLOY_DIR}/

          # ì‘ì—… ë””ë ‰í† ë¦¬ ì´ë™
          cd /home/ubuntu/coplan

          # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ë³µì‚¬ (ìˆëŠ” ê²½ìš°ë§Œ)
          if [ -f "/home/ubuntu/env/${ENV_FILE}" ]; then
            echo "ğŸ“‹ Copying environment variables..."
            cp "/home/ubuntu/env/${ENV_FILE}" "${DEPLOY_DIR}/.env.production"
          fi

          # Docker ì´ë¯¸ì§€ ë¹Œë“œ
          echo "ğŸ”¨ Building Docker image..."
          DOCKER_BUILDKIT=1 docker compose build ${CONTAINER_NAME}

          # ì»¨í…Œì´ë„ˆ êµì²´ (ë¬´ì¤‘ë‹¨ ë°°í¬)
          echo "ğŸ”„ Updating container..."
          docker compose up -d --no-deps ${CONTAINER_NAME}

          # ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
          echo "ğŸ”„ Restarting other container..."
          docker compose up -d ${OTHER_CONTAINER}

          # í—¬ìŠ¤ì²´í¬
          echo "ğŸ¥ Health check..."
          sleep 10

          if docker ps | grep -q ${CONTAINER_NAME}; then
            echo "âœ… Container is running"
            docker logs --tail 20 ${CONTAINER_NAME}
          else
            echo "âŒ Container failed to start"
            docker logs ${CONTAINER_NAME}
            exit 1
          fi

          echo "âœ… Deployment completed successfully!"
