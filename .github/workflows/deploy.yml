name: Deploy to EC2

on:
  pull_request:
    types: [closed]
    branches: [main, develop]

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v3

      - name: Deploy to EC2
        run: |
          set -e  # ì—ëŸ¬ ì‹œ ì¤‘ë‹¨

          # ë°°í¬ ë¡œê¹…
          echo "ğŸš€ Starting deployment..."
          echo "ğŸ“ PR: #${{ github.event.pull_request.number }}"

          # ë¸Œëœì¹˜ë³„ í™˜ê²½ ì„¤ì •
          if [ "${{ github.event.pull_request.base.ref }}" = "main" ]; then
            CONTAINER_NAME="coplan-prod"
            echo "ğŸš€ Deploying to PRODUCTION"
          elif [ "${{ github.event.pull_request.base.ref }}" = "develop" ]; then
            CONTAINER_NAME="coplan-dev"
            echo "ğŸ§ª Deploying to DEVELOPMENT"
          fi

          # ì½”ë“œ ë³µì‚¬
          cp -r . /home/ubuntu/coplan/app/
          cd /home/ubuntu/coplan

          # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ë³µì‚¬ (ìˆëŠ” ê²½ìš°ë§Œ)
          if [ -f "/home/ubuntu/env/${CONTAINER_NAME}.env" ]; then
            echo "ğŸ“‹ Copying environment variables..."
            cp /home/ubuntu/env/${CONTAINER_NAME}.env ./app/.env.production
          fi

          # ë¹Œë“œ ë° ë°°í¬
          docker compose build $CONTAINER_NAME
          docker compose up -d --no-deps --build $CONTAINER_NAME

          # ê°„ë‹¨í•œ í—¬ìŠ¤ì²´í¬
          sleep 10
          docker ps | grep $CONTAINER_NAME

          echo "âœ… Deployment completed!"
