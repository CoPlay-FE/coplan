name: Deploy to EC2

on:
  pull_request:
    types: [closed]
    branches: [main, develop]

jobs:
  # 환경 체크 단계 분리
  warmup:
    runs-on: self-hosted
    timeout-minutes: 3
    steps:
      - name: Environment check
        run: |
          echo "=== System Check ==="
          whoami                
          docker --version       
          free -h               # 메모리 상태 사전 체크
          docker ps             # 현재 컨테이너 상태

  deploy:
    needs: warmup # ✅ warmup 완료 후 실행
    runs-on: self-hosted
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 스크립트 분리
      - name: Execute deployment script
        run: |
          echo "🚀 Starting deployment..."
          echo "🔄 Branch: ${{ github.ref_name }}"
          echo "🔄 Commit: ${{ github.sha }}"

          # 단순히 스크립트만 실행
          cd /home/ubuntu/coplan
          chmod +x ./deploy.sh
          ./deploy.sh

      # 헬스체크
      - name: Health check
        run: |
          echo "🏥 Health checking..."
          sleep 15

          if docker ps | grep -q $DOCKER_CONTAINER_NAME; then
            echo "✅ Deployment completed!"
            docker logs --tail 5 $DOCKER_CONTAINER_NAME
            echo "🌐 https://coplan.work"  # ✅ HTTPS
          else
            echo "❌ Deployment failed!"
            docker logs $DOCKER_CONTAINER_NAME 2>/dev/null || echo "No logs"
            exit 1
          fi
