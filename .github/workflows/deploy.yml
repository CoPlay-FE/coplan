name: Deploy to EC2

on:
  pull_request:
    types: [closed]
    branches: [main, develop]

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: self-hosted
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to EC2
        run: |
          echo "ğŸš€ Starting deployment..."
          echo "ğŸ”„ Branch: ${{ github.ref_name }}"
          echo "ğŸ”„ Commit: ${{ github.sha }}"

          # ë©”ëª¨ë¦¬ ì •ë¦¬
          echo "ğŸ§¹ Cleaning up memory..."
          docker system prune -f

          # ì•± ë””ë ‰í† ë¦¬ë¡œ ì½”ë“œ ë³µì‚¬
          echo "ğŸ“‚ Copying files..."
          rsync -av --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.next' \
            ./ /home/ubuntu/coplan/app/

          # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /home/ubuntu/coplan

          # Docker ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
          echo "ğŸ”„ Restarting containers..."
          docker compose down
          docker compose up -d --build

          # í—¬ìŠ¤ì²´í¬
          echo "ğŸ¥ Health checking..."
          sleep 15

          if docker ps | grep -q coplan-app; then
            echo "âœ… Deployment completed successfully!"
            docker logs --tail 10 coplan-app
            echo "ğŸŒ Service available at: http://15.164.127.149"
          else
            echo "âŒ Deployment failed!"
            docker logs coplan-app
            exit 1
          fi
