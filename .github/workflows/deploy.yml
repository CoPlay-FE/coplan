name: Deploy to EC2

on:
  pull_request:
    types: [closed]
    branches: [main, develop]

env:
  DOCKER_CONTAINER_NAME: coplan-app

jobs:
  warmup:
    # ğŸ›¡ï¸ ë¨¸ì§€ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: github.event.pull_request.merged == true
    runs-on: self-hosted
    timeout-minutes: 3
    steps:
      - name: Environment check
        run: |
          echo "=== Deployment System Check ==="
          echo "ğŸ“‹ Merged PR: ${{ github.event.pull_request.title }}"
          echo "ğŸ‘¤ Author: ${{ github.event.pull_request.user.login }}"
          echo "ğŸ”„ From: ${{ github.event.pull_request.head.ref }} â†’ ${{ github.event.pull_request.base.ref }}"
          echo "ğŸ“ Commit: ${{ github.event.pull_request.merge_commit_sha }}"
          echo ""
          echo "ğŸ–¥ï¸ System Status:"
          whoami                
          docker --version       
          free -h
          echo ""
          echo "ğŸ³ Container Status:"
          docker ps

  deploy:
    needs: warmup
    runs-on: self-hosted
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Execute deployment script
        run: |
          echo "ğŸš€ Starting deployment..."
          echo "ğŸ”„ Branch: ${{ github.ref_name }}"
          echo "ğŸ”„ Commit: ${{ github.sha }}"
          echo "ğŸ“¦ PR: #${{ github.event.pull_request.number }}"

          # deploy.sh ì‹¤í–‰
          cd /home/ubuntu/coplan
          chmod +x ./deploy.sh
          ./deploy.sh

      - name: Health check
        run: |
          echo "ğŸ¥ Health checking..."
          sleep 15

          if docker ps | grep -q $DOCKER_CONTAINER_NAME; then
            echo "âœ… Deployment completed successfully!"
            echo "ğŸ“Š Container status:"
            docker ps | grep $DOCKER_CONTAINER_NAME
            echo ""
            echo "ğŸ“ Recent logs:"
            docker logs --tail 5 $DOCKER_CONTAINER_NAME
            echo ""
            echo "ğŸŒ Service available at: https://coplan.work"
          else
            echo "âŒ Deployment failed!"
            echo "ğŸ” Checking container logs..."
            docker logs $DOCKER_CONTAINER_NAME 2>/dev/null || echo "No container logs available"
            echo "ğŸ” Checking system status..."
            docker ps -a
            free -h
            exit 1
          fi
