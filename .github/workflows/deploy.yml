name: Deploy to EC2

on:
  pull_request:
    types: [closed]
    branches: [main, develop]

jobs:
  # í™˜ê²½ ì²´í¬ ë‹¨ê³„ ë¶„ë¦¬
  warmup:
    runs-on: self-hosted
    timeout-minutes: 3
    steps:
      - name: Environment check
        run: |
          echo "=== System Check ==="
          whoami                
          docker --version       
          free -h               # ë©”ëª¨ë¦¬ ìƒíƒœ ì‚¬ì „ ì²´í¬
          docker ps             # í˜„ìž¬ ì»¨í…Œì´ë„ˆ ìƒíƒœ

  deploy:
    needs: warmup # âœ… warmup ì™„ë£Œ í›„ ì‹¤í–‰
    runs-on: self-hosted
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ìŠ¤í¬ë¦½íŠ¸ ë¶„ë¦¬
      - name: Execute deployment script
        run: |
          echo "ðŸš€ Starting deployment..."
          echo "ðŸ”„ Branch: ${{ github.ref_name }}"
          echo "ðŸ”„ Commit: ${{ github.sha }}"

          # ë‹¨ìˆœížˆ ìŠ¤í¬ë¦½íŠ¸ë§Œ ì‹¤í–‰
          cd /home/ubuntu/coplan
          chmod +x ./deploy.sh
          ./deploy.sh

      # í—¬ìŠ¤ì²´í¬
      - name: Health check
        run: |
          echo "ðŸ¥ Health checking..."
          sleep 15

          if docker ps | grep -q $DOCKER_CONTAINER_NAME; then
            echo "âœ… Deployment completed!"
            docker logs --tail 5 $DOCKER_CONTAINER_NAME
            echo "ðŸŒ https://coplan.work"  # âœ… HTTPS
          else
            echo "âŒ Deployment failed!"
            docker logs $DOCKER_CONTAINER_NAME 2>/dev/null || echo "No logs"
            exit 1
          fi
