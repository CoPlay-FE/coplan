name: CI Pipeline

on:
  pull_request:
    branches: [develop, main]
  push:
    branches: [develop, main]

jobs:
  eslint-check:
    runs-on: self-hosted
    timeout-minutes: 2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # HEADì™€ ë² ì´ìŠ¤ ë¸Œëœì¹˜ íˆìŠ¤í† ë¦¬ í™•ë³´

      - name: Lightning fast lint check
        run: |
          echo "âš¡ Quick lint check..."

          # ë©”ëª¨ë¦¬ ìƒíƒœ ì‚¬ì „ ì²´í¬
          AVAILABLE_MB=$(free -m | grep ^Mem | awk '{print $7}')
          echo "ğŸ’¾ Available memory: ${AVAILABLE_MB}MB"

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # PRì¸ ê²½ìš°: ë² ì´ìŠ¤ ë¸Œëœì¹˜ì™€ ë¹„êµ
            BASE_BRANCH="${{ github.base_ref }}"
            git fetch origin $BASE_BRANCH --depth=1
            
            ALL_CHANGED=$(git diff --name-only origin/$BASE_BRANCH...HEAD -- '*.ts' '*.tsx' '*.js' '*.jsx')
            FILE_COUNT=$(echo "$ALL_CHANGED" | wc -w)
            
            echo "ğŸ“Š Base: $BASE_BRANCH, Changed files: $FILE_COUNT"
            
            # ğŸ›¡ï¸ ë©”ëª¨ë¦¬ ê¸°ë°˜ ì•ˆì „ì¥ì¹˜
            if [ "$AVAILABLE_MB" -lt 200 ]; then
              MAX_FILES=10
              echo "âš ï¸ Low memory mode: checking $MAX_FILES files only"
            elif [ "$FILE_COUNT" -gt 30 ]; then
              MAX_FILES=30
              echo "âš ï¸ Large PR detected: checking first $MAX_FILES files for memory safety"
              echo "â„¹ï¸ Note: Full project will be built during deployment"
            else
              MAX_FILES="$FILE_COUNT"
              echo "âœ… Normal mode: checking all $FILE_COUNT files"
            fi
            
            CHANGED_FILES=$(echo "$ALL_CHANGED" | head -$MAX_FILES)
            
          else
            # Pushì¸ ê²½ìš°: ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµ
            echo "ğŸ” Push event detected"
            if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
              CHANGED_FILES=$(git diff --name-only HEAD~1 -- '*.ts' '*.tsx' '*.js' '*.jsx')
              echo "ğŸ“ Checking files changed since last commit"
            else
              echo "ğŸ” First commit or shallow clone, checking recent files"
              CHANGED_FILES=$(find . -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | grep -v node_modules | head -5)
            fi
          fi

          # ë³€ê²½ì‚¬í•­ ì—†ìœ¼ë©´ ì¦‰ì‹œ ì¢…ë£Œ
          if [ -z "$CHANGED_FILES" ]; then
            echo "âœ… No JS/TS files to check"
            exit 0
          fi

          # ìµœì¢… ì‹¤í–‰ ì •ë³´
          FINAL_COUNT=$(echo $CHANGED_FILES | wc -w)
          ESTIMATED_MB=$((FINAL_COUNT * 2))
          echo "ğŸ§  Checking $FINAL_COUNT files (~${ESTIMATED_MB}MB estimated)"
          echo "ğŸ“ Files: $CHANGED_FILES"

          # ê¸€ë¡œë²Œ ESLint ì‹¤í–‰
          npx eslint $CHANGED_FILES
          echo "âœ… Lint check passed!"
